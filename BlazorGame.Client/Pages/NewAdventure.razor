@page "/new-adventure"
@using SharedModels
@using BlazorGame.Client.Pages.Components
@using System.Net.Http.Json
@inject HttpClient Http

<h1>Nouvelle aventure</h1>

@if (loading)
{
    <p><em>Démarrage de l'aventure...</em></p>
}
else if (error != null)
{
    <div class="alert alert-danger">@error</div>
    <button class="btn btn-primary" @onclick="StartNewAdventure">Réessayer</button>
}
else if (adventureCompleted)
{
    <div class="alert alert-success">
        <h3>✅ Aventure terminée !</h3>
        <p><strong>Score final :</strong> @currentScore points</p>
        @if (isDead)
        {
            <p class="text-danger">💀 Vous êtes mort pendant l'aventure...</p>
        }
        else
        {
            <p class="text-success">🎉 Vous avez survécu !</p>
        }
    </div>
    <button class="btn btn-primary" @onclick="StartNewAdventure">Nouvelle aventure</button>
}
else if (currentRoom != null)
{
    <div class="score-display">
        <strong>Score actuel :</strong> @currentScore points | <strong>Salle</strong> @(currentRoomIndex + 1)/@totalRooms
    </div>
    
    <RoomCard Room="currentRoom" OnChoiceSelected="HandleChoice" />
}

@code {
    private bool loading = true;
    private string? error = null;
    private int adventureId;
    private Room? currentRoom;
    private int currentScore = 0;
    private int currentRoomIndex = 0;
    private int totalRooms = 0;
    private bool adventureCompleted = false;
    private bool isDead = false;

    protected override async Task OnInitializedAsync()
    {
        await StartNewAdventure();
    }

    private async Task StartNewAdventure()
    {
        loading = true;
        error = null;
        adventureCompleted = false;
        isDead = false;
        currentScore = 0;
        currentRoomIndex = 0;

        try
        {
            // Hardcoded playerId pour démo - en prod, il viendrait de l'authentification
            var response = await Http.PostAsJsonAsync("/api/adventures", new { PlayerId = 1 });
            
            if (!response.IsSuccessStatusCode)
            {
                error = $"Erreur lors du démarrage de l'aventure : {response.StatusCode}";
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<AdventureStartResponse>();
            if (result == null)
            {
                error = "Réponse invalide du serveur";
                return;
            }

            adventureId = result.AdventureId;
            totalRooms = result.TotalRooms;
            
            if (result.CurrentRoom != null)
            {
                currentRoom = new Room
                {
                    Title = result.CurrentRoom.RoomTitle,
                    Type = ParseRoomType(result.CurrentRoom.RoomType),
                    Description = result.CurrentRoom.Description
                };
            }
        }
        catch (Exception ex)
        {
            error = $"Erreur : {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task HandleChoice(string choice)
    {
        loading = true;
        error = null;

        try
        {
            var response = await Http.PostAsJsonAsync(
                $"/api/adventures/{adventureId}/choices",
                new { Choice = choice }
            );

            if (!response.IsSuccessStatusCode)
            {
                error = $"Erreur lors de la soumission du choix : {response.StatusCode}";
                loading = false;
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<ChoiceResponse>();
            if (result == null)
            {
                error = "Réponse invalide du serveur";
                loading = false;
                return;
            }

            currentScore = result.NewScore;
            currentRoomIndex = result.RoomIndex;
            
            if (result.IsDead)
            {
                isDead = true;
                adventureCompleted = true;
                currentRoom = null;
            }
            else if (result.IsComplete)
            {
                adventureCompleted = true;
                currentRoom = null;
            }
            else if (result.NextRoom != null)
            {
                currentRoom = new Room
                {
                    Title = result.NextRoom.RoomTitle,
                    Type = ParseRoomType(result.NextRoom.RoomType),
                    Description = result.NextRoom.Description
                };
            }
        }
        catch (Exception ex)
        {
            error = $"Erreur : {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private RoomType ParseRoomType(string type) => type switch
    {
        "Enemy" => RoomType.Enemy,
        "Treasure" => RoomType.Treasure,
        "Trap" => RoomType.Trap,
        _ => RoomType.Enemy
    };

    // DTOs pour la communication API
    private class AdventureStartResponse
    {
        public int AdventureId { get; set; }
        public int TotalRooms { get; set; }
        public RoomDto? CurrentRoom { get; set; }
    }

    private class ChoiceResponse
    {
        public int NewScore { get; set; }
        public int RoomIndex { get; set; }
        public bool IsComplete { get; set; }
        public bool IsDead { get; set; }
        public RoomDto? NextRoom { get; set; }
    }

    private class RoomDto
    {
        public string RoomTitle { get; set; } = "";
        public string RoomType { get; set; } = "";
        public string Description { get; set; } = "";
    }
}
